#include "defs.h"

void decrypt_main(const uint8 key_basis[16], uint8 dst[16]);
void bind_key(const uint8 decrypted_key[16], const uint8 file_id[20], uint8 dst[16]);
uint32 process(char a1, uint32 a2, uint32 a3, uint32 a4, uint32 a5);

template <typename A>
unsigned char _bittest(A *a, int b)
{
    unsigned char *bits = (unsigned char *)a;
    unsigned char value = bits[b >> 3];
    unsigned char mask = (unsigned char)(1 << (b & 7));
    return (value & mask) != 0;
}

static unsigned int U8TOU32(const unsigned char *p) {
    return (((unsigned int)(p[0] & 0xff)) | ((unsigned int)(p[1] & 0xff) << 8) |
            ((unsigned int)(p[2] & 0xff) << 16) | ((unsigned int)(p[3] & 0xff) << 24));
}

static int char2int(char input)
{
    if (input >= '0' && input <= '9')
        return input - '0';
    if (input >= 'A' && input <= 'F')
        return input - 'A' + 10;
    if (input >= 'a' && input <= 'f')
        return input - 'a' + 10;
    return -1;
}

static void hex2bin(const char *src, char *target)
{
    while (*src && src[1])
    {
        int high = char2int(*src);
        int low = char2int(src[1]);
        if (high == -1 || low == -1)
        {
            return;
        }
        *(target++) = (char)(high * 16 + low);
        src += 2;
    }
}

// linked data for 01284ff3343a03d01f1b89218a6ad75e
static const uint32 playIntentKey[0x300] = {
		0x4FA3DAD5, 0x0D138FD72, 0x0E2F3EFA1, 0x6489123E, 0x87C287D7,
		0x180CD6B, 0x0F7E50EEC, 0x5108A8E4, 0x0D29DCB81, 0x0C2DA8DF,
		0x8DC2CB7C, 0x9F7DBDAA, 0x0FDE55291, 0x0F949DCFA, 0x0B04CF29,
		0x8C99F1C6, 0x0D9276ED, 0x8F27998A, 0x0A0E28BB9, 0x0FF4A209F,
		0x110512CE, 0x929A356B, 0x0CC2A12C9, 0x0C78E9D32, 0x4923BFCF,
		0x0A24759C7, 0x0AEEEAE, 0x1269E0DC, 0x0BBD3EEA9, 0x0CD8EE0D7,
		0x4F240374, 0x3DB167EC, 0x3915F256, 0x0D1017CB8, 0x3BA39A1A,
		0x0BD38BCB7, 0x0CEF3AEE6, 0x5088D183, 0x3F1635FB, 0x58A80532,
		0x0FA3B35F5, 0x0F59FC05F, 0x0BE9D8AC6, 0x0EE85C1C2, 0x51ED9F91,
		0x407B0409, 0x0C21026A6, 0x0FBA00404, 0x1531D33B, 0x8EF018D0,
		0x67271582, 0x3024DFE9, 0x87E20214, 0x0EB49DFE4, 0x0FD04D212,
		0x7E99F4B0, 0x9054E6DE, 0x86B9285F, 0x776DF3, 0x41DE2859,
		0x30515B7, 0x1C96E4EF, 0x7FFEC2BE, 0x0D7BBE4E9, 0x0AFF2E19C,
		0x29B12731, 0x4342F668, 0x0BD013BFC, 0x0D6930B34, 0x0BF8EE3C1,
		0x0B5F32541, 0x2FB16AD6, 0x49433A0D, 0x5AFE2C3B, 0x0BE660A0B,
		0x0FFCCC471, 0x2E889120, 0x0B757F350, 0x311638E4, 0x4AA8081B,
		0x0C4664DB0, 0x5CD0816, 0x0F45A6C8E, 0x57C24A5D, 0x87AA815A,
		0x0EB125F29, 0x73E1C159, 0x0EDA006ED, 0x731D625, 0x0F5BF3A9C,
		0x77545D3A, 0x890F4F68, 0x0AA47205, 0x44344F63, 0x0A79C2D33,
		0x896A433, 0x5F275C11, 0x78B92B48, 0x0B24908A6, 0x33DE2B43,
		0x45991D72, 0x0A400B258, 0x0B5BBA486, 0x19238256, 0x7A1DF957,
		0x0B3ADD6B4, 0x3542F951, 0x46FDEB80, 0x0A5658066, 0x0B7207295,
		0x38B59532, 0x72457290, 0x3B433CF6, 0x4CFE2F25, 0x4862B98F,
		0x0A6CA4E75, 0x0B88540A4, 0x61EF4E70, 0x73AA409E, 0x0F53F633B,
		0x0E3CCC7B3, 0x0ACCA921A, 0x0BE858448, 0x0E1BEF9E1, 0x63541C7E,
		0x750F0EAD, 0x0F6A4314A, 0x0E53195C2, 0x66C6B85F, 0x0A05695BD,
		0x1510CBD, 0x7B0F5252, 0x94A12189, 0x0E5F671E, 0x0E69663D0,
		0x682B866D, 0x0A1BB63CB, 0x23508668, 0x7C742060, 0x0BDDADAC7,
		0x0EC96A775, 0x2DFD61DB, 0x0A7BBA770, 0x0A32031DA, 0x24B55477,
		0x367046A5, 0x94D7DB8C, 0x15D060B3, 0x2F622FEA, 0x0A920757F,
		0x0C2B244B6, 0x3C708A4A, 0x5FA9FFE3, 0x0AC93115F, 0x0CFCC86F8,
		0x0FFB4BDF4, 0x0AA85438D, 0x0EBEBFDF3, 0x65AA4388, 0x5C0E8508,
		0x0D5CCCA9D, 0x0EF5E99D4, 0x691CDF69, 0x648169D2, 0x0BC3E8BFE,
		0x670F1196, 0x5D735317, 0x0D73198AB, 0x0F0C367E3, 0x6A81AD77,
		0x0ABE867DD, 0x0DAA4348C, 0x0FDDDAA25, 0x752E88EA, 0x0F6C3AB87,
		0x19FD2120, 0x93BB66B5, 0x0AD4D35EC, 0x3DDEDCA, 0x1D6FBD01,
		0x2F2AAF2F, 0x92928CFF, 0x31B856F4, 0x0B34D7991, 0x0C5086BBF,
		0x542BBD8, 0x1ED48B0F, 0x9892D0A4, 0x0D9F98B0A, 0x0EBB47D39,
		0x4A1C121F, 0x0A33FAC17, 0x24D4CEB4, 0x368FC0E3, 0x0C1CC89E1,
		0x0F1B4C0DE, 0x0ED194B47, 0x4B80E02E, 0x5D3BD25C, 0x0DED0F4F9,
		0x5FC97A20, 0x0E15E9CBE, 0x0F3198EEC, 0x74AEB189, 0x633C1601,
		0x86758B9A, 0x80AAE37, 0x19C5A066, 0x0E2C36ACC, 0x0F47E5CFB,
		0x52E5F1E1, 0x64A0E410, 0x0E63606AD, 0x1FC5E40A, 0x1B2A6E74,
		0x0B315F8D6, 0x8B4CF589, 0x544ABFEF, 0x8DDA9D4D, 0x0F6FBFEA,
		0x212AB219, 0x32E5A448, 0x0B47AC6E5, 0x8CB1C397, 0x4C723929,
		0x47D6C392, 0x10D48DF9, 0x228F8027, 0x0A424A2C5, 0x92B2073C,
		0x0D418C1A3, 0x4DD70737, 0x5F91F966, 0x0E1271C03, 0x460919C,
		0x0CD5E5C02, 0x0BBEBC07A, 0x3D80E317, 0x4F3BD546, 0x68CDA47D,
		0x0E28BEA12, 0x1C1BC76F, 0x52AE7126, 0x0DB7DD356, 0x3EE5B126,
		0x50A0A354, 0x0A85DC580, 0x0BC5A34F, 0x229E4CF, 0x7BE82A64,
		0x8DA31C93, 0x0F383F30, 0x9807A15F, 0x11C5E6F4, 0x0D2A715E,
		0x19E51AA3, 0x7D4CF872, 0x96DEC7AA, 0x109D0D3E, 0x5203C7A5,
		0x80BF9453, 0x98EF683, 0x834D3C17, 0x7EB1C681, 0x0D66EE8AC,
		0x39D6C67C, 0x69BEFD78, 0x0A9F94D91, 0x0C38B1CC8, 0x3D49625D,
		0x9E43D95D, 0x0D7D3B6BB, 0x5968D958, 0x6B23CB87, 0x0AB5E1B9F,
		0x0DB46529B, 0x3EAE306B, 0x966B5296, 0x413BD82F, 0x5ACDA766,
		0x495B0BDE, 0x0CAF02E7B, 0x4800BD9, 0x67E7E9A9, 0x97D020A5,
		0x0FB37FE74, 0x7F2A7BA, 0x0B2C32D53, 0x0CC54FC8A, 0x5E4D9E8,
		0x8779FC85, 0x9934EEB3, 0x0FC9CCC83, 0x95775C8, 0x6CBF5398,
		0x0C47C75C3, 0x749A7F6, 0x88DECA93, 0x9A99BCC2, 0x0F90151A8,
		0x0ABC43D7, 0x0B42651A3, 0x0C5E143D2, 0x294921A1, 0x5931589D,
		0x0C3D37600, 0x0FA661FB7, 0x33F5FD14, 0x0B58B1FB1, 0x0C74611E0,
		0x48DB347D, 0x826B11DB, 0x49238B24, 0x39F640B9, 0x355ACB23,
		0x0CD465585, 0x0C8AADFEF, 0x4A40028C, 0x38CD6704, 0x0BA6289A1,
		0x0F3F266FE, 0x5AD592D, 0x0CEAB2394, 0x0F1E4992C, 0x89D0238E,
		0x62072041, 0x0E39C42DE, 0x0F557350D, 0x76EC57AA, 0x88A749D9,
		0x0C2372736, 0x680763E6, 0x636BEE50, 0x0FB5778B2, 0x0F6BC031B,
		0x8EA78D7E, 0x0B1E10316, 0x0BE9BAC5C, 0x22038A2B, 0x82FE012C,
		0x0FCBC46C0, 0x3E230127, 0x0B7E146BB, 0x0C99C38EA, 0x2803CDD0,
		0x2368583A, 0x53508F36, 0x0B6B86D05, 0x3F87CF35, 0x0B94614CA,
		0x0AFAA564A, 0x29689BDF, 0x3B238E0D, 0x0BCB8B0AA, 0x0DFF22643,
		0x0FDA5D3F, 0x5014AD58, 0x0B10F2459, 0x2ACD69ED, 0x6C342453,
		0x0E5F269E8, 0x0F7AD5C17, 0x113F2B4E, 0x51797B66, 0x8161B263,
		0x0E4C99032, 0x83EF5A27, 0x0E75737F6, 0x0E9072E, 0x5779BF0B,
		0x710B8E43, 0x0AA9B6BA0, 0x2459B135, 0x3DEB806C, 0x6E94AD3,
		0x18A43D01, 0x58DE8D1A, 0x72705C51, 0x14038D15, 0x2D955C4C,
		0x3F504E7B, 0x0B90E940F, 0x0AF72D58F, 0x78709FF6, 0x0B2007D54,
		0x15685B23, 0x4550921F, 0x40B51C89, 0x9F1CB16F, 0x0B0D7A39E,
		0x5A41B16A, 0x6BFCA399, 0x34FA6DFF, 0x46B5602E, 0x0AA1D3DFE,
		0x0B6D7E743, 0x0DA115CDC, 0x71FCE73E, 0x6D6171A7, 0x0EEF69444,
		0x288671A2, 0x0A681C323, 0x0E011A080, 0x0F1CC92AF, 0x7361B54C,
		0x6EC63FB6, 0x6B1CA18, 0x0DEE8C6CB, 0x607DE968, 0x0E1766E8F,
		0x630B912C, 0x74C6835B, 0x0AE5660B9, 0x2FEB8356, 0x8228008,
		0x0A00E0A6A, 0x9B7294D4, 0x335E1F36, 0x9E003C98, 0x1F955F35,
		0x0E22C3AD, 0x1FDDB5DC, 0x0A172D879, 0x0B32DCAA8, 0x34C2ED45,
		0x6E52CAA3, 0x0A4E5745A, 0x0F8791BC, 0x291960F3, 0x0A2D7A688,
		0x0E43E60EE, 0x5DFCA682, 0x6FB798B1, 0x0CE1F2D97, 0x0DFDA1FC6,
		0x616F4263, 0x0CC115FC5, 0x0FBF996C1, 0x5F617491, 0x55C5B611,
		0x0CF83FBA6, 0x0E13EEDD4, 0x62D41072, 0x9C63EDCF, 0x6561B836,
		0x60C6429F, 0x6D80EBE5, 0x0D0E8C9B4, 0x28A5EBE0, 0x8C0DC9AF,
		0x9DC8BBDE, 0x1F5DDE7B, 0x0DEB42F3, 0x6EE5B9F3, 0x0D24D97C3,
		0x2A0AB9EE, 0x8D7297BE, 0x0BD5ACEBA, 0x0FD951ED3, 0x1726EE0A,
		0x90E5339E, 0x0CA7510FC, 0x2B6F87FD, 0x0A52DCD91, 0x0BEBF9CC8,
		0x0FEF9ECE1, 0x2EE223DD, 0x0BA1EECDC, 0x0EA0723D8, 0x4D6F01A8,
		0x5F29F3D6, 0x0E7F95606, 0x1E8BFFBD, 0x581BDD1B, 0x0BB83BAEA,
		0x0EB6BF1E7, 0x4ED3CFB6, 0x5B8E78FC, 0x7EC7EE94, 0x47C5B8FB,
		0x5980AB29, 0x0DB15CDC7, 0x0ECD0BFF5, 0x668F058A, 0x5CF3470A,
		0x0C05B24DA, 0x18184705, 0x137CD16F, 0x0DC7A9BD5, 0x160A7933,
		0x4C9D22EA, 0x862D0048, 0x0FFEB45DC, 0x197D1513, 0x2B380742,
		0x0ACCD29DF, 0x85042692, 0x8C2D43ED, 0x8791CE56, 0x926F0F3,
		0x1AE1E322, 0x9C7705BF, 0x0D606E31D, 0x0C4944795, 0x46296A32,
		0x88F69C65, 0x20E226C7, 0x441B9C60, 0x0DC0726C2, 0x0B43E2374,
		0x35D34612, 0x478E3840, 0x59492A6F, 0x0DADE4D0C, 0x5BD6D233,
		0x0DD6BF4D0, 0x0B5A2F183, 0x4D8E7BE5, 0x48F3064F, 0x8282E3AC,
		0x418064A, 0x15D2F878, 0x743A8D5E, 0x0CD5E2756, 0x4EF349F4,
		0x722CBF8C, 0x0A1849EE, 0x57CD458, 0x12377D9D, 0x759F5B6D,
		0x875A4D9C, 0x8EF7039, 0x89E7F560, 0x0B7D17FD, 0x1D380A2C,
		0x7B9F9F12, 0x7704297B, 0x0CEC14BA7, 0x32292976, 0x43E41BA5,
		0x0CE1E60B, 0x2673B543, 0x7D046D20, 0x8EBF5F4F, 0x0D02619B5,
		0x49E45F4A, 0x63762E81, 0x0A3B07E9A, 0x0B56B70C8, 0x7E693B2F,
		0x0BFCFF595, 0x398E3B2A, 0x4B492D58, 0x8CAFE7BF, 0x0BB6BB46D,
		0x0FCD26ED4, 0x603A4CA3, 0x9022839F, 0x3AF30938, 0x6ADB4034,
		0x0CE431E04, 0x0BCD0827C, 0x0FE373CE2, 0x77F58277, 0x918751AE,
		0x0B459742, 0x1A9D8C3, 0x0AC7A5E5C, 0x4378087, 0x0FF9C0AF1,
		0x81312D8E, 0x92EC1FBC, 0x0CAA6551, 0x30EA6D1, 0x0A4A1D795,
		0x59C4E95, 0x69042C65, 0x98EC6361, 0x0BC25D8FA, 0x90EEA76,
		0x2C48600F, 0x0A606A5A3, 0x0BF9874DB, 0x3956BA6F, 0x0C2261C9F,
		0x0D3E10ECE, 0x3248A3B4, 0x2DAD2E1D, 0x0C598B87F, 0x0C0FD42E9,
		0x3ABB887E, 0x7C2242E4, 0x0AADE0F93, 0x33AD71C2, 0x456863F1,
		0x0C6FD868E, 0x8D63EC, 0x82228689, 0x5A59833C, 0x0F2450D9E,
		0x0EDA99807, 0x6767DD9C, 0x0F0373FCC, 0x1F231FA, 0x83875497,
		0x7214B90F, 0x0F3A9DBAC, 0x0EF0E6616, 0x86F9F078, 0x0AA336611,
		0x218444D6, 0x84EC22A6, 0x7379871E, 0x0F50EA9BB, 0x2E9E8719,
		0x0B033A9B6, 0x0C1EE9BE4, 0x205630CA, 0x1BBABB34, 0x930B99FA,
		0x0F67377C9, 0x30035527, 0x0B19877C4, 0x0C35369F3, 0x21BAFED9,
		0x3375F108, 0x0B50B13A5, 0x0EE9AF103, 0x4F956803, 0x0B2FD45D3,
		0x0EC8D2330, 0x231FCCE8, 0x5CAFAA45, 0x0DE44CCE2, 0x0EFFFBF11,
		0x9918E48, 0x60224626, 0x0C11CBD27, 0x24849AF6, 0x7C41BD21,
		0x0DFA99AF1, 0x0F1648D20, 0x72F9AFBD, 0x61871434, 0x0A2EDCE9B,
		0x4DBE5434, 0x7DA68B30, 0x0E10E68FF, 0x10F69FFC, 0x745E7DCB,
		0x62EBE243, 0x0C55F00F, 0x1E10E23E, 0x37A2B175, 0x0F8C99ED3,
		0x3A305939, 0x5295BE23, 0x0AA52E04E, 0x0DBABE1E, 0x1F75B04C,
		0x39077F84, 0x0DA9AB047, 0x0D0FEF1C8, 0x9225DF25, 0x0ABB7AE5D,
		0x2575F3F1, 0x3F07C328, 0x0A26FA0F8, 0x0AF2A4A3D, 0x0D263BFD6,
		0x4C22056B, 0x0AD1C7C6B, 0x2EB19F08, 0x68417C66, 0x0E1FFC1FB,
		0x0D864037B, 0x3BCBE14A, 0x6BB41847, 0x7D6F0A75, 0x0E0D6E845,
		0x69A64A75, 0x0EB3B6D12, 0x0D9C8D189, 0x5387171E, 0x6D18E655,
		0x0A6A8C3B3, 0x283DE650, 0x16CB4AC8, 0x7A332897, 0x0DB2D9F98,
		0x731929FA, 0x96529F93, 0x1010E527, 0x29A2B45F, 0x183018D6,
		0x99C53B73, 0x0AB802DA2, 0x2D15503F, 0x97B76DA1, 0x2FA2F803,
		0x2B07826D, 0x1994E6E5, 0x9B2A0982, 0x0D4B9E6E0, 0x564F097D,
		0x6809FBAB, 0x3107C612, 0x93EC2C5, 0x0A12A4D27, 0x0C463C2C0,
		0x0D61EB4EE, 0x57B3D78B, 0x696EC9BA, 0x0C7D65EA0, 0x0D99150CF,
		0x0A28F1B35, 0x0DC1EF893, 0x5DB41B30, 0x5918A59A, 0x92A882F8,
		0x0C93B2CAF, 0x2CB0A0C, 0x84602CAA, 0x961B1ED8, 0x5F18E93F,
		0x70D3DB6D, 0x67381CEE, 0x0E0F66282, 0x42FD81B, 0x85C4FAB8,
		0x977FECE7, 0x19150F84, 0x7A273FC, 0x0D0A03E62, 0x0A301BC0,
		0x23C1EAF7, 0x9D80308C, 0x0B711FFC3, 0x58A53087, 0x30DC2D39,
		0x0B2714FD6, 0x29C22E9C, 0x8D2A0C6C, 0x9EE4FE9A, 0x0E04BB900,
		0x0F0785AF, 0x506E4015, 0x0CA2C85AA, 0x0C5911014, 0x472632B1,
		0x0E64BFCA5, 0x0E1B0870F, 0x38413EED, 0x51D30E24, 0x0CB9153B8,
		0x0E52322F0, 0x5EE16884, 0x0A04822EA, 0x0B8AD87D4, 0x57D351C9,
		0x5337DC32, 0x0CCF621C7, 0x0E5CDC2D, 0x881B21C2, 0x7E7F6342,
		0x0F83DA8D7, 0x11CF780E, 0x8B8DBDA2,
};